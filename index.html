<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ÙƒØªØ´Ù Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        body { font-family: sans-serif; background-color: #f8f9fa; text-align: center; padding: 20px; color: #333; }
        .container { max-width: 420px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        video { width: 100%; border-radius: 15px; background: #000; min-height: 250px; }
        
        #status-box { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 10px; 
            font-weight: bold; 
            background: #e9ecef; 
            font-size: 0.95rem;
            word-wrap: break-word; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø®Ø±ÙˆØ¬ Ø§Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ */
        }

        button {
            padding: 15px;
            font-size: 1.1rem;
            border: none;
            border-radius: 12px;
            width: 100%;
            font-weight: bold;
            color: white;
            background-color: #6c757d; /* Ø±Ù…Ø§Ø¯ÙŠ */
            pointer-events: none;
            transition: 0.3s;
        }

        button.ready { background-color: #28a745; pointer-events: auto; } /* Ø£Ø®Ø¶Ø± */
    </style>
</head>
<body>

    <div class="container">
        <h3>ğŸ” Ø§Ù„Ù…ÙƒØªØ´Ù Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª</h3>
        
        <video id="webcam" autoplay playsinline muted></video>

        <div id="status-box">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬...</div>

        <button id="startBtn">Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹...</button>
    </div>

    <script>
        const statusBox = document.getElementById('status-box');
        const btn = document.getElementById('startBtn');
        let FoundClass = null; // Ù‡Ù†Ø§ Ø³Ù†Ø®Ø²Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ Ø§Ù„Ø°ÙŠ Ø³Ù†Ø¬Ø¯Ù‡

        // Ø¯Ø§Ù„Ø© ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        window.startDiscovery = function() {
            console.log("File loaded. Starting discovery...");
            
            // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© ÙÙŠ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­
            const candidates = Object.keys(window).filter(key => 
                key.toLowerCase().includes('edge') || 
                key.toLowerCase().includes('impulse') ||
                key.toLowerCase().includes('classifier')
            );

            // 2. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­
            if (window.EdgeImpulseClassifier) {
                FoundClass = window.EdgeImpulseClassifier;
                statusBox.innerHTML = "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡ Ø¨Ø§Ø³Ù…: <br> EdgeImpulseClassifier";
            } else if (candidates.length > 0) {
                // Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ Ø§Ø³Ù… Ù†Ø¬Ø¯Ù‡ ÙŠØ¨Ø¯Ùˆ ØµØ­ÙŠØ­Ø§Ù‹
                FoundClass = window[candidates[0]];
                statusBox.innerHTML = `âœ… ÙˆØ¬Ø¯Ù†Ø§ Ø§Ø³Ù…Ø§Ù‹ Ø¨Ø¯ÙŠÙ„Ø§Ù‹: <br> ${candidates[0]}`;
                console.log("Found alternative:", candidates[0]);
            } else {
                statusBox.innerHTML = "âš ï¸ Ø§Ù„Ù…Ù„Ù ØªØ­Ù…Ù„ØŒ Ù„ÙƒÙ† Ø§Ù„Ø§Ø³Ù… Ù…Ø®ÙÙŠ! <br> Ø¬Ø±Ø¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.";
                statusBox.style.background = "#fff3cd";
                return;
            }

            // 3. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
            statusBox.style.background = "#d4edda"; 
            statusBox.style.color = "#155724";
            btn.innerText = "ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù† ğŸš€";
            btn.classList.add('ready');
            btn.onclick = runSystem;
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        window.fileError = function() {
            statusBox.innerText = "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù JS. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙÙŠ GitHub.";
            statusBox.style.background = "#f8d7da";
        };

        async function runSystem() {
            btn.style.display = 'none';
            statusBox.innerText = "ğŸ“¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„";
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('webcam').srcObject = stream;

                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ Ø§ÙƒØªØ´ÙÙ†Ø§Ù‡
                const classifier = new FoundClass();
                await classifier.init();

                statusBox.innerText = "ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø¯...";
                statusBox.style.background = "white";
                statusBox.style.border = "2px solid #28a745";

                setInterval(async () => {
                    try {
                        const results = await classifier.classify(document.getElementById('webcam'));
                        if (results.results.length > 0) {
                            const best = results.results.reduce((a, b) => a.value > b.value ? a : b);
                            statusBox.innerHTML = `<span style="font-size:1.5rem;color:#28a745">${best.label}</span> <br> ${Math.round(best.value * 100)}%`;
                        }
                    } catch(e) {}
                }, 500);

            } catch (err) {
                statusBox.innerText = "Ø®Ø·Ø£: " + err.message;
            }
        }
    </script>

    <script src="./edge-impulse-standalone.js?v=5" onload="startDiscovery()" onerror="fileError()"></script>

</body>
</html>
